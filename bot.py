#!/usr/bin/env python3
"""
Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨ÙˆØª Ø§Ù„ØªÙˆØµÙŠÙ„
"""

import logging
import asyncio
from telegram.ext import Application, CommandHandler, MessageHandler, filters, CallbackQueryHandler
from telegram.error import TelegramError

from config import config
from database.database import db_manager

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª
from handlers.user import UserHandlers
from handlers.driver import DriverHandlers
from handlers.ride import RideHandlers
from handlers.admin import AdminHandlers
from middleware.chat_manager import ChatManager

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

class DeliveryBot:
    """Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ø¨ÙˆØª"""
    
    def __init__(self):
        self.application = None
        self.user_handlers = None
        self.driver_handlers = None
        self.ride_handlers = None
        self.admin_handlers = None
        self.chat_manager = None
    
    def init_app(self):
        """ØªÙ‡ÙŠØ¦Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨ÙˆØª"""
        try:
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒÙˆÙŠÙ†
            config.validate()
            
            # ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            db_manager.init_database()
            
            # Ø¥Ù†Ø´Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨ÙˆØª
            self.application = Application.builder().token(config.bot.BOT_TOKEN).build()
            
            # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª
            self.user_handlers = UserHandlers()
            self.driver_handlers = DriverHandlers()
            self.ride_handlers = RideHandlers()
            self.admin_handlers = AdminHandlers()
            self.chat_manager = ChatManager()
            
            # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª
            self._register_handlers()
            
            logger.info("ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙˆØª Ø¨Ù†Ø¬Ø§Ø­")
            return True
            
        except Exception as e:
            logger.error(f"ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙˆØª: {e}")
            return False
    
    def _register_handlers(self):
        """ØªØ³Ø¬ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¨ÙˆØª"""
        
        # Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        user_handlers = self.user_handlers.get_handlers()
        for handler in user_handlers:
            self.application.add_handler(handler)
        
        # Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†
        driver_handlers = self.driver_handlers.get_handlers()
        for handler in driver_handlers:
            self.application.add_handler(handler)
        
        # Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª
        ride_handlers = self.ride_handlers.get_handlers()
        for handler in ride_handlers:
            self.application.add_handler(handler)
        
        # Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù†
        admin_handlers = self.admin_handlers.get_handlers()
        for handler in admin_handlers:
            self.application.add_handler(handler)
        
        # Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
        chat_handlers = self.chat_manager.get_handlers()
        for handler in chat_handlers:
            self.application.add_handler(handler)
        
        # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        self.application.add_error_handler(self.error_handler)
        
        # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ø§Ù…Ø©
        self.application.add_handler(MessageHandler(
            filters.TEXT & ~filters.COMMAND,
            self.handle_unknown_message
        ))
    
    async def error_handler(self, update: object, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…Ø©"""
        try:
            raise context.error
        except TelegramError as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…: {e}")
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: {e}", exc_info=True)
            
            # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØ­Ø¯ÙŠØ«
            if update and hasattr(update, 'effective_chat'):
                try:
                    await context.bot.send_message(
                        chat_id=update.effective_chat.id,
                        text="Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹."
                    )
                except:
                    pass
    
    async def handle_unknown_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ø¹Ø±ÙˆÙØ©"""
        await update.message.reply_text(
            "Ù„Ù… Ø£ÙÙ‡Ù… Ø±Ø³Ø§Ù„ØªÙƒ. ğŸ¤”\n\n"
            "ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ§Ù„ÙŠØ©:\n"
            "/start - Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª\n"
            "/help - Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©\n"
            "/menu - Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"
        )
    
    async def on_startup(self, application: Application):
        """Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„"""
        logger.info("Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª...")
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø£Ø¯Ù…Ù†
        for admin_id in config.bot.ADMIN_IDS:
            try:
                await application.bot.send_message(
                    chat_id=admin_id,
                    text="ğŸŸ¢ ØªÙ… Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø¨ÙˆØª Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!"
                )
            except Exception as e:
                logger.error(f"ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø£Ø¯Ù…Ù† {admin_id}: {e}")
    
    async def on_shutdown(self, application: Application):
        """Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¹Ù†Ø¯ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ´ØºÙŠÙ„"""
        logger.info("Ø¥ÙŠÙ‚Ø§Ù ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª...")
        
        # Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù„Ø³Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        db_manager.close_session()
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø£Ø¯Ù…Ù†
        for admin_id in config.bot.ADMIN_IDS:
            try:
                await application.bot.send_message(
                    chat_id=admin_id,
                    text="ğŸ”´ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø¨ÙˆØª Ø§Ù„ØªÙˆØµÙŠÙ„."
                )
            except Exception as e:
                logger.error(f"ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø£Ø¯Ù…Ù† {admin_id}: {e}")
    
    def run(self):
        """ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª"""
        if not self.init_app():
            logger.error("ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙˆØª. Ø§Ù„Ø®Ø±ÙˆØ¬...")
            return
        
        try:
            # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©
            self.application.run_polling(
                on_startup=self.on_startup,
                on_shutdown=self.on_shutdown,
                allowed_updates=[
                    "message",
                    "callback_query",
                    "inline_query",
                    "chosen_inline_result",
                    "channel_post",
                    "edited_message",
                    "edited_channel_post"
                ],
                drop_pending_updates=True
            )
            
        except KeyboardInterrupt:
            logger.info("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….")
        except Exception as e:
            logger.error(f"ÙØ´Ù„ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª: {e}")
        finally:
            logger.info("Ø¥ÙŠÙ‚Ø§Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª...")


def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    bot = DeliveryBot()
    bot.run()


if __name__ == "__main__":
    main()
